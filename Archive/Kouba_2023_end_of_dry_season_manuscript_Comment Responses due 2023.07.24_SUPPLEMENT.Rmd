---
title: Supplemental Material - Seasonal prediction of end-of-dry season watershed behavior in a highly interconnected alluvial watershed, northern California
journal: "`r rticles::copernicus_journal_abbreviations(journal_name = 'Hydrology and Earth System Sciences')`"
author:
    # authors can have multiple affiliations, which can also be used to mark deceased coauthors
  - given_name: Claire
    surname: Kouba
    affiliation: "1"
    email: cmkouba@ucdavis.edu
    corresponding: true
  - given_name: Thomas
    surname: Harter
    affiliation: 1
    email: thharter@ucdavis.edu
# If you have more than one corresponding author, add them manually using the following structure (note the commas):
# Two authors: Daniel Nüst (daniel.nuest@uni-muenster.de) and Josiah Carberry (j.carberry@orcid.org)
# Three authors or more: Daniel Nüst (daniel.nuest@uni-muenster.de), Josiah Carberry (j.carberry@orcid.org), and Markus Konkol (m.konkol@wwu.de)
# If the following line is uncommented, the "corresponding: true" above are ignored
#correspongdingauthors: Daniel Nüst (daniel.nuest@uni-muenster.de) and Josiah Carberry (j.carberry@orcid.org)
# If authors contributed equally, please mark the respective author names with an asterisk '*' and add a further affiliation: 'These authors contributed equally to this work.'", see template.
affiliation:
  - code: 1
    address: Department of Land, Air and Water Resources, University of California, Davis, One Shields Avenue, Davis, CA, United States
abstract: |
  In undammed watersheds in Mediterranean climates, the timing and abruptness of the transition from the dry season to the wet season have major implications for aquatic ecosystems. Of particular concern in many coastal areas is whether this transition can provide sufficient flows at the right time to allow passage for spawning anadromous fish, which is determined by dry season baseflow rates and the timing of the onset of the rainy season. In (semi-) ephemeral watershed systems, these functional flows also dictate the timing of full reconnection of the stream system. 
  In this study, we propose methods to predict, approximately five months in advance, two key hydrologic metrics in the undammed rural Scott River watershed (HUC8 18010208) in northern California. Both metrics are intended to quantify the transition from the dry to the wet season, to characterize the severity of a dry year and support seasonal adaptive management. The first metric is the minimum 30-day dry season baseflow volume, $V_{min,~30~days}$, which occurs at the end of the dry season (September-October) in this Mediterranean climate. The second metric is the cumulative precipitation, starting Sept. 1st, necessary to bring the watershed to a "full" or "spilling" condition (i.e. initiate the onset of wet season storm- or baseflows) after the end of the dry season, referred to here as $P_{spill}$. As potential predictors of these two values, we assess maximum snowpack, cumulative precipitation, the timing of the snowpack and precipitation, spring groundwater levels, spring river flows, reference ET, and a subset of these metrics from the previous water year. 
  We find that, though many of these predictors are correlated with the two metrics of interest, of the predictors considered here, the best prediction for both metrics is a linear combination of the maximum snowpack water content and total October-April precipitation. These two linear models could reproduce historic values of $V_{min,~30~days}$ and $P_{spill}$ with an average model error (RMSE) of 1.4 Mm^3^ / 30 days (19.4 cfs) and 20.7 mm (0.8 inches), respectively. Although these predictive indices could be used by governance entities to support local water management, careful consideration of baseline conditions used as a basis for prediction is necessary.
bibliography: library.bib
running:
  title: Seasonal prediction of end-of-dry season watershed behavior in a highly interconnected alluvial watershed, northern California
  author: Kouba and Harter
competinginterests: |
  The authors declare no competing interests.
# See https://publications.copernicus.org/for_authors/licence_and_copyright.html, normally used for transferring the copyright, if needed. 
# Note: additional copyright statements for affiliated software or data need to be placed in the data availability section. 
copyrightstatement: |
  The authors retain copyright for this publication. 
### Note: unless stated otherwise, software and data affiliated with the manuscript are assumed to be published under the same licence as the article (currently Creative Commons 4.0)
availability:
  #  use this to add a statement when having only software code available
  #  use this to add a statement when having only data sets available
  #code: |
  #data: |
  codedata: |
    Analyses and figures in this manuscript were drafted in RMarkdown. The RMarkdown scripts are available on the corresponding author's GitHub page. All data used in this manuscript are publicly available on local, state or federal data portals.
#sample: |
  #use this section when having geoscientific samples available
#videosupplement: |
  #use this section when having video supplements available
# authorcontribution: |
# disclaimer: |
acknowledgements: |
  This manuscript emerged from dissertation work funded by Siskiyou County SGMA planning grants, with funding from California water bonds.
# appendix: |
  # \section{Figures and tables in appendices}
  # \subsection{Option 1}
  # If you sorted all figures and tables into the sections of the text, please also sort the appendix figures and appendix tables into the respective appendix sections.
  # They will be correctly named automatically.
  # \subsection{Option 2}
  # If you put all figures after the reference list, please insert appendix tables and figures after the normal tables and figures.
  # 
  # `\appendixfigures` needs to be added in front of appendix figures
  # `\appendixtables` needs to be added in front of appendix tables
  # 
  # Please add `\clearpage` between each table and/or figure. Further guidelines on figures and tables can be found below.
  # Regarding figures and tables in appendices, the following two options are possible depending on your general handling of figures and tables in the manuscript environment:
  # To rename them correctly to A1, A2, etc., please add the following commands in front of them:
output:
  rticles::copernicus_article: 
    highlight: NULL
    keep_tex: true
  bookdown::pdf_book:
    base_format: rticles::copernicus_article # for using bookdown features like \@ref()
---


```{r libraries, include = FALSE, warning=F}


knitr::opts_chunk$set(echo = TRUE, message = FALSE)

library(lubridate)
library(rgdal)
library(rpostgis)
library(postGIStools)
library(httr)
library(stringr)
library(rstudioapi)
library(dataRetrieval) # for usgs data
# library(devtools); devtools::install_github("flowwest/CDECRetrieve") # This line only needs to be run once to install the CDECRetrieve package (which is not available on CRAN)
library(CDECRetrieve) # for CDEC data
library(data.table) #month function
library(zoo) # rolling means
library(plyr)  # for barplots for climate fig
library(rgl) # plot3d
library(ggplot2) # water budget bar chart
library(ggthemes) # colorblindpal()
library(ggpubr) # to use get_palette()
library(colorspace) # diverging_hcl color palette
#spatial data libraries
library(rgeos)
library(maptools)
library(RANN)
library(tmap)
library(RColorBrewer)
library(raster)
library(xtable)
library(scales) # for alpha() color function
library(boot) # for loocv
library(qpcR) # for AICc function
library(terra)
library(sf)
library(here)


```
  
```{r directories_load_data, include = F, warning = F}

# Directories
ms_dir = here::here()

# Load spatial and tabular data
# If the data files don't exist locally,
if(!file.exists(file.path(ms_dir,"manuscript_data.RData"))){
  #pulls data into R from local files and internet
  source(file.path(ms_dir,"01_DataRetrieval_Cleaning_SaveLocal.R")) 
}
load(file.path(ms_dir, "manuscript_data.RData")) # Load data layers/tables
source(file.path(ms_dir,"02_Figure_Functions.R"))   # Load figure functions

# settings to save figs to image files
running_fig_num = 0
img_res = 300
update_watershed_figure = T # figure takes a few moments to render; no need to rerender unless an update is desired

```



Monthly volume of stream-aquifer exchange, estimated using SVIHM [@Tolley2019], can be used to further investigate baseflow generation and the boundaries between the draining and spilling flow domains. In most months, the aquifer discharge and stream leakage components of the exchange tend to be of equivalent volume, and net stream-aquifer exchange near 0 (\autoref{fig:flow_to_aq_and_stream}, upper panel). Exceptions to this tend to happen only at high Scott River flowrates; all net groundwater-to-stream flux volumes of >0.25 Mm^3^ / 30 days (approximately `r round(0.25*Mm3month_AugDec_to_cfs,1)` cfs) occur at simulated Fort Jones flowrates of >20 Mm^3^ (approximately `r round(20*Mm3month_AugDec_to_cfs,)` cfs; \autoref{fig:flow_to_aq_and_stream}, lower panel). 

Additionally, net monthly stream-aquifer exchange volume tends to be an order of magnitude lower than the flow simulated at the Fort Jones gauge. Clear seasonal trends in the net exchange volume suggest that in the winter and spring, precipitation events can temporarily produce large pulses in groundwater discharge. In the summer growing season, when flows are high (e.g. > 10 Mm^3^/month, during the early summer snowmelt period), the result tends to be net aquifer recharge, but at low flowrates, the surface water flow is sustained by groundwater discharge. Similarly, very low dry season flows (e.g., < 1 Mm^3^/month) are largely composed of groundwater discharge, but when flowrates are higher the direction of net stream-aquifer exchange is more variable, responding to the elevation of the proximate groundwater (\autoref{fig:flow_to_aq_and_stream}, lower panel).

```{r generate_flow_to_aq_and_stream, echo=FALSE, include=F}

# save as png and include in Rmd
running_fig_num = running_fig_num+1
running_fig_num_txt = str_pad(running_fig_num, width = 2, side = "left", pad="0")
fig_file_name = paste0("f",running_fig_num_txt, ".png")

png(filename = fig_file_name, height = 7.5, width = 7, units = "in", res = img_res)
flow_to_aq_and_stream_fig()
dev.off()
```

```{r flow_to_aq_and_stream, echo=FALSE, fig.cap="\\label{fig:flow_to_aq_and_stream} Both stream leakage and aquifer discharge increase in the rainy season, while net flux to the stream remains relatively close to 0 (top panel). Strong seasonal trends are evident in net flux to the stream (lower panel; described further in text)." , out.width = "100%", warning=F}
knitr::include_graphics(fig_file_name)
```


## Observed response variables

### Dry season baseflow quantity and timing, and Scott River eras

```{r num_for_fall_flows, echo = F, include = F, warning = F}

# calculate low from eras 1  and 2
low_era1 = min(dsb_tab[dsb_tab$year %in% 1942:1976,
                             c("aug_flow","sep_flow")])/10^6

low_era2 = min(dsb_tab[dsb_tab$year %in% 1977:2021,
                             c("aug_flow","sep_flow")])/10^6

min_flows = dsb_tab$min_30day_flow_jul_dec_cal_yr / 10^6
min_flow_range = range(min_flows, na.rm=T)
outlier = min_flows[ min_flows >10 & !is.na(min_flows)]
min_flow_range_no_outlier = range(min_flows[min_flows!=outlier & !is.na(min_flows)])

```

Minimum 30-day dry season baseflow volumes, denoted here as $V_{min, ~30~days}$, have ranged from `r round(min_flow_range_no_outlier[1],1)` to `r round(min_flow_range_no_outlier[2],1)` Mm^3^ / 30 days, with one outlier value of `r round(outlier,1)` Mm^3^ / 30 days in 1984, when an early September storm followed a wet year in 1983 (\autoref{fig:fall_flows_data_exp}). 

Three periods of water use and climate forces have been proposed for the Scott River [e.g., by @Pyschik2022]: Eras 1, 2, and 3, ranging from 1942-1976, 1977-2000, and 2001-2021, respectively. These eras are separated by the low minimum flow in the year 1977, which corresponds to the widespread installation of groundwater pumps, and by the onset of a two-decade abnormally dry period in 2000.

Matching other long-term declining flow trends in this watershed, the flows in August and September are relatively steady in Era 1, and they become more variable with significantly lower lows in Eras 2 and 3 (minimum of `r round(low_era1,1)` Mm^3^ / 30 days [`r round(low_era1 * Mm3month_30day_to_cfs,1)` average cfs] in 1942-1976 and `r round(low_era2,1)` Mm^3^ / 30 days [`r round(low_era2* Mm3month_30day_to_cfs,1)` average cfs] in 1977-2021; \autoref{fig:fall_flows_data_exp}, upper panel). 

The timing of the midpoint of the 30-day minimum-flow period falls most commonly in September, though it has fluctuated over the last eight decades (\autoref{fig:fall_flows_data_exp}, middle panel). 

```{r generate_fall_flows_data_exp, echo=FALSE, include=F}

# save as png and include in Rmd
running_fig_num = running_fig_num+1
running_fig_num_txt = str_pad(running_fig_num, width = 2, side = "left", pad="0")
fig_file_name = paste0("f",running_fig_num_txt, ".png")

png(filename = fig_file_name, height = 7, width = 7, units = "in", res = img_res)
par(mfrow = c(3,1), mar = c(2, 5,3,5))
fall_flows_fig()
fall_min_flow_timing_fig()
p_spill_fig()
dev.off()
```

```{r fall_flows_data_exp, echo=FALSE, fig.cap="\\label{fig:fall_flows_data_exp} FJ Gauge flow volume, by year, aggregated to monthly time windows in the late summer, fall, and early winter. Eras are noted that correspond to various management and climate forces (e.g., the widespread installation of groundwater wells in the late 1970s, and the onset of a two-decade abnormally dry period in 2000). " , out.width="100%", warning=F}
knitr::include_graphics(fig_file_name)
# 0.1 Mm3 per 30 days is equal to 1.4 cfs

```


### Cumulative fall precipitation and watershed response

```{r num_for_p_spill, echo = F, include = F, warning = F}

# calculate low from eras 1  and 2
p_spill_range = range(dsb_tab$cum_ppt_on_first_day_100cfs, na.rm=T)
mean_era1 = mean(dsb_tab[dsb_tab$year %in% 1942:1976,
                             "cum_ppt_on_first_day_100cfs"], na.rm=T)
mean_era2 = mean(dsb_tab[dsb_tab$year %in% 1977:2000,
                             "cum_ppt_on_first_day_100cfs"])
mean_era3 = mean(dsb_tab[dsb_tab$year %in% 2001:2021,
                             "cum_ppt_on_first_day_100cfs"], na.rm=T)

```

In some water years prior to the 1980s, the Fort Jones flowrate exceeded $Q_{spill}$ on September 1st (\autoref{fig:time_v_fall_rains_v_flow_fig}, panels A and B), indicating that even under persistent dry season draining conditions, under the climate and water use conditions of wet years in the mid-20th century, the Scott River remained responsive to new precipitation year-round. As a result, the range of $P_{spill}$, the cumulative precipitation necessary to reach $Q_{spill}$, is wide (`r round(p_spill_range[1])` to `r round(p_spill_range[2])` mm, or `r round(p_spill_range[1]*mm_to_in)` to `r round(p_spill_range[2]*mm_to_in)` inches) (\autoref{fig:fall_flows_data_exp}, lower panel). Mean $P_{spill}$ values were `r round(mean_era1)`, `r round(mean_era2)`, and `r round(mean_era3)` mm in Eras 1, 2 and 3, respectively.

## Predictor comparison for $V_{min.~30~days}$ and $P_{spill}$

```{r corr_matrix_prep, warning = F, comment = F, include = F, echo = F}

### Prep to make correlation matrix figure
# Isolate best stations in each category
keep_wx = c("USC00041316","USC00043182", "USC00048025","interp_cal_fj")#,"USC00049866")
keep_snow = c("MBL", "MB3", "SWJ")
keep_wells = c("415635N1228315W001","416295N1228926W001")

keep_wx_last= c("USC00043182")#,"USC00049866")
keep_snow_last = c("SWJ")
keep_wells_last = c("416295N1228926W001", "415635N1228315W001")

# add WLs to dry season baseflow tab
if(sum(grepl(pattern = keep_wells[1], x = colnames(dsb_tab))) == 0){
  dsb_tab = add_wls_to_fall_flows(dsb_tab = dsb_tab,
                                        fft_well_ids = keep_wells)
  # dsb_tab_20namax = add_wls_to_fall_flows(dsb_tab = dsb_tab_20namax,
  #                                   fft_well_ids = keep_wells)
}

# add previous WY values for DWR WYT comparison. and predicting P_spil!!!
make_prev_yr_cols = c(paste0(keep_snow_last,"_max_wc_mm"),
                      paste0(keep_wx_last,"_oct_apr_mm"), 
                      # paste0("aprWL_",keep_wells_last))
                      paste0("springWL_",keep_wells_last))
n_yrs = nrow(dsb_tab)
for(i in 1:length(make_prev_yr_cols)){
  column = make_prev_yr_cols[i]
  #make new column
  dsb_tab[,paste0(column,"_last_year")] = NA
  dsb_tab[2:n_yrs, paste0(column,"_last_year")] = dsb_tab[1:(n_yrs-1),column]
  # check 2 year lag just for kicks. yeah, no p_spill effect.
  # dsb_tab[3:n_yrs, paste0(column,"_last_year")] = dsb_tab[1:(n_yrs-2),column]
}

# Save the dsb table
write.csv(dsb_tab, file.path(ms_dir, "Supplemental","dry season baseflows and predictors.csv"))

# Corr matrix figure prep
### dsb_tab enhancements:
#assign era colors for plots of pred. v obs.
dsb_tab$era_color_minflow = era_tab$color_minflow[match(dsb_tab$era,
                                                        era_tab$era)]
dsb_tab$era_color_pspill = era_tab$color_pspill[match(dsb_tab$era,
                                                      era_tab$era)]

# Reduce dry season baseflow table to the best predictors in each category
keep_these_cols = c(#"year", "sep_flow", 
  "min_fall_flow", "cum_ppt_on_first_day_100cfs",
  "mar_flow","apr_flow",
  paste0(keep_snow,"_max_wc_mm"),
  paste0(keep_wx,"_oct_apr_mm"), 
  paste0("springWL_",keep_wells),#paste0("aprWL_",keep_wells),
  "et0_oct_apr",
  paste0(keep_snow,"_jday_of_max"),paste0(keep_wx,"_jday_of_median"),
  paste0(keep_snow_last,"_max_wc_mm_last_year"),
  paste0(keep_wx_last,"_oct_apr_mm_last_year"), 
  paste0("springWL_",keep_wells_last,"_last_year")) # paste0("aprWL_",keep_wells_last,"_last_year"))


#find indices for numbers in text below
min_fall_flow_index = grep(pattern = "min_fall_flow", keep_these_cols)
p_spill_index = grep(pattern = "cum_ppt_on_first_day_100cfs", keep_these_cols)
mar_flow_index = grep(pattern = "mar_flow", keep_these_cols)
apr_flow_index = grep(pattern = "apr_flow", keep_these_cols) 
snow_indices = which(grepl(pattern = "max_wc_mm",  keep_these_cols) &
                       !grepl(pattern = "last", keep_these_cols))
precip_indices = which(grepl(pattern = "oct_apr_mm",  keep_these_cols) &
                         !grepl(pattern = "last", keep_these_cols))
et_index = grep(pattern = "et0", keep_these_cols)
# wl_indices = which(grepl(pattern = "aprWL",  keep_these_cols) &
#                      !grepl(pattern = "last", keep_these_cols))
wl_indices = which(grepl(pattern = "springWL",  keep_these_cols) &
                     !grepl(pattern = "last", keep_these_cols))
four_cat_indices = range(c(mar_flow_index, apr_flow_index, 
                           snow_indices, precip_indices, wl_indices))
snowjd_indices = grep(pattern = "jday_of_max", keep_these_cols)
precipjd_indices = grep(pattern = "jday_of_median", keep_these_cols)
last_yr_indices = grep(pattern="last",keep_these_cols)

```



```{r generate_corr_matrix, echo=FALSE, include=F}

# save as png and include in Rmd
running_fig_num = running_fig_num+1
running_fig_num_txt = str_pad(running_fig_num, width = 2, side = "left", pad="0")
fig_file_name = paste0("f",running_fig_num_txt, ".png")

png(filename = fig_file_name, height = 7, width = 7, units = "in", res = img_res)
cor_mat = corr_matrix_fig_ch3(keep_these_cols = keep_these_cols) # make plot and retrieve corr. matrix
dev.off()

```

```{r corr_matrix, echo=FALSE, fig.cap="\\label{fig:corr_matrix} Correlation coefficient matrix of two response variables, minimum 30-day dry season baseflow volumes (V min) and cumulative precipitation necessary to produce 100 cfs in the Scott River (P spill), with various possible predictor metrics. Gray, purple, and blue squares highlight the inter-category correlation coefficients of snowpack metrics, Oct-April cumulative precipitation, and March-May groundwater elevation measurements. Red and yellow rectangles highlight the predictors with the greatest absolute correlation coefficient values with V min and P spill, respectively." , out.width="100%", warning=F}

knitr::include_graphics(fig_file_name)

```


```{r num_for_section_pred_comp, echo=FALSE, warning=F}
# set diagonal to be NA values
cor_mat_na = cor_mat
diag(cor_mat_na) = NA
# ranges of categories of correlation coeff
min_fall_flow_four_cat_range = range(cor_mat_na[min_fall_flow_index,
                                                four_cat_indices[1]:four_cat_indices[2]])
p_spill_four_cat_range = range(cor_mat_na[p_spill_index, four_cat_indices[1]:four_cat_indices[2]])

# snow_w_snow_corr_range = range(cor_mat_na[snow_indices, snow_indices], na.rm=T)
# ppt_w_ppt_corr_range =  range(cor_mat_na[precip_indices, precip_indices], na.rm=T)
# wl_w_wl_corr_range = range(cor_mat_na[wl_indices, wl_indices],na.rm=T)
# four_cat_corr_range = range(snow_w_snow_corr_range, ppt_w_ppt_corr_range, wl_w_wl_corr_range)

snow_tim_corr_range_vmin = range(cor_mat_na[min_fall_flow_index,snowjd_indices],na.rm=T)
snow_tim_corr_range_pspill = range(cor_mat_na[p_spill_index,snowjd_indices],na.rm=T)


# precip_tim_corr_range = range(cor_mat_na[precipjd_indices, precipjd_indices],na.rm=T)
# timing_corr_range = range(snow_tim_corr_range, precip_tim_corr_range)

pspill_four_cat_range = range(cor_mat_na[p_spill_index, four_cat_indices[1]:four_cat_indices[2]])

vmin_last_range  = range(cor_mat_na[min_fall_flow_index, last_yr_indices[1]:last_yr_indices[2]])
pspill_last_range = range(cor_mat_na[p_spill_index, last_yr_indices[1]:last_yr_indices[2]])

```

The observations of spring flows, snowpack, valley floor precipitation, and groundwater elevation are positively correlated both within each category and to each other overall, which is unsurprising: wet years are associated with higher values in all of these categories. Groundwater wells with highest predictive power tend to have long records (e.g., $n$ of 10 or greater years) and to be close to the Scott River (\autoref{fig:gw_vs_fall_flows_corr_map}); these results incorporate two wells proximate to the river, with 43 and 57-year records. 

Both response variables are strongly correlated with four categories of observations: spring flowrates, maximum snow water content, cumulative precipitation recorded at weather stations or or near the valley floor (October-April), and March-May water levels in some wells. Observations in these categories are positively correlated with $V_{min.~30~days}$ and negatively correlated with $P_{spill}$. The correlation coefficient, $R$, of these response-predictor relationships range from  `r round(min_fall_flow_four_cat_range[1],2)` to `r round(min_fall_flow_four_cat_range[2],2)` for $V_{min.~30~days}$ and from `r round(p_spill_four_cat_range[2],2)` to `r round(p_spill_four_cat_range[1],2)` for $P_{spill}$ (\autoref{fig:corr_matrix}). 

In contrast to these four categories, October-April cumulative ET~0~ is negatively correlated with $V_{min.~30~days}$ and positively correlated with $P_{spill}$ ($R$ of `r round(cor_mat_na[min_fall_flow_index, et_index],2)` and `r round(cor_mat_na[p_spill_index, et_index],2)` for $V_{min.~30~days}$ and $P_{spill}$, respectively). October-April cumulative ET~0~ is also negatively correlated with snow, precipitation, and groundwater level indicators. While ET can remove a significant volume of water from the watershed, this correlation reflects the fact that years with more rainy or stormy days accumulate less total insolation and atmospheric water demand, rather than indicating that high ET is driving low flows. Additionally, the relatively high absolute values of $R$ for between ET~0~ and the two response variables may be due to a small sample size, as all available ET~0~ observations or estimates were collected in 2002 or later (i.e., in Era 3; \autoref{fig:one_predictor_model}).

Some meteorological timing was evaluated in addition to quantities. Both response variables are somewhat correlated with snow timing (i.e., the Julian day of the maximum measured snowpack in a given year; $R$ of `r round(snow_tim_corr_range_vmin[1],2)` to `r round(snow_tim_corr_range_vmin[2],2)` and `r round(snow_tim_corr_range_pspill[2],2)` to `r round(snow_tim_corr_range_pspill[1],2)` for $V_{min.~30~days}$ and $P_{spill}$, respectively), but no significant correlation is evident between the response variables and precipitation timing (\autoref{fig:corr_matrix}). 

Finally, a subset of observations from the previous water year were included in the correlation matrix to test for multi-year influence on the response variables. These previous-year metrics had a slight positive correlation with $V_{min.~30~days}$ ($R$ of `r round(vmin_last_range[1],2)` to `r round(vmin_last_range[2],2)`), and an even slighter negative correlation with $P_{spill}$ ($R$ of `r round(pspill_last_range[2],2)` to `r round(pspill_last_range[1],2)`), providing moderate evidence that the previous year's hydroclimate conditions on can affeca given fall season.


```{r generate_gw_vs_fall_flows_corr_map, echo=FALSE, include=F}

# save as png and include in Rmd
running_fig_num = running_fig_num+1
running_fig_num_txt = str_pad(running_fig_num, width = 2, side = "left", pad="0")
fig_file_name = paste0("f",running_fig_num_txt, ".png")

png(filename = fig_file_name, height = 7, width = 7, units = "in", res = img_res)
highlight_wells = get_high_corr_wells(show_map = T, corr_wells = keep_wells) # 
dev.off()
```

```{r gw_vs_fall_flows_corr_map, echo=FALSE, fig.cap="\\label{fig:gw_vs_fall_flows_corr_map} Boundary of the groundwater basin (corresponding approximately to the extent of the flat valley floor in the Scott River watershed) and selected well locations. Colors correspond to the correlation coefficients between April groundwater elevations and September flow volume. The wells included in the predictor comparison are highlighted with a red outer square." , out.width="100%", warning=F}

knitr::include_graphics(fig_file_name)

```

## Predicted values of $V_{min.~30~days}$

### Predictor assessment and prediction formula

In each of six high-$R$ categories, the monitoring location in each category with the highest $R$ value with observed $V_{min.~30~days}$ values was selected for further analysis (\autoref{fig:one_predictor_model}). Out of this set of six, the maximum snowpack and October-April cumulative precipitation produce the lowest model errors (LOOCV errors of 2.74 and 2.72 Mm^3^, respectively; \autoref{fig:one_predictor_model}, top two panels). In combinations of two predictors, a linear combination of maximum snowpack and cumulative precipitation improved on the best single-predictor model, with an LOOCV error of 2.29 Mm^3^ (\autoref{fig:two_predictor_model}, upper left panel).

Among the two-predictor models evaluated was a combination of maximum snowpack water content and the timing of the maximum measurement (\autoref{fig:two_predictor_model}, top right panel). This produced a slightly larger error (2.78 Mm^3^) than the single-predictor model with maximum snowpack water content alone (2.74 Mm^3^; \autoref{fig:one_predictor_model}, middle left panel), indicating that the timing of maximum snow accumulation is either relatively unimportant in generating dry season baseflows -- perhaps because, regardless of the peak time, the melting snowpack becomes recharge, which moves slowly enough through the subsurface to buffer the timing of snowmelt -- or that the actual timing of snowpack maximum is not captured in temporally sparse snow course measurements. 

Additionally, two models featuring a partial one-year holdover were evaluated, to test the validity of this component of the methodology of DWR's Water Year Type index. In both cases, the addition of the climate data from the previous year produced a very small change in model error (\autoref{fig:two_predictor_model}, two lower panels), indicating that in the Scott Valley context, the previous year's climate may have a minor influence on dry season flows relative to the immediately preceding rainy season.

Based on these results, the model selected as the $V_{min.~30~days}$ prediction formulation was a linear combination of snowpack maximum from the Swampy John (SWJ) snow station (with data collected by CDEC) and cumulative October-April precipitation from the Fort Jones Ranger Station (FJRS) weather station (with data collected by NOAA) as follows:

$$V_{min.,~30~days,~i} = -1.33 + 0.00525 * FJRS_{Oct-Apr,~i}+0.00267*SWJ_{max,~i}$$

Where:

* $V_{min.,~30~days,~i}$ is the predicted value of minimum 30-day dry season baseflows in calendar year $i$ (i.e., at the end of water year $i$) (million m^3^ or Mm^3^)
* $SWJ_{max,~i}$ is the maximum snow water content recorded at the Swampy John snow course (CDEC station ID SWJ or 285) in water year $i$ (millimeters)
* $FJRS_{Oct-Apr,~i}$ is the cumulative precipitation, recorded October-April of water year $i$, measured at the Fort Jones Ranger Station (NOAA station ID USC00043182) (millimeters)



```{r prep_one_predictor_model, echo=FALSE, include=F}


#Reduce columns for the error calc and prediction calc
tab_for_glm = dsb_tab[,
                            c("era","era_color_minflow","min_fall_flow","SWJ_max_wc_mm",
                               "USC00043182_oct_apr_mm",
                              "springWL_415635N1228315W001",#"springWL_416295N1228926W001",
                              #"aprWL_415635N1228315W001",
                               "SWJ_jday_of_max","et0_oct_apr", "mar_flow", 
                           "SWJ_max_wc_mm_last_year","USC00043182_oct_apr_mm_last_year")]
# tab_for_glm = dsb_tab_20namax[,c("era","era_color","min_fall_flow","SWJ_max_wc_mm",
#                                "USC00043182_oct_apr_mm","aprWL_415635N1228315W001",
#                                "SWJ_jday_of_max","et0_oct_apr", "mar_flow")]#,
#                                # "SWJ_max_wc_mm_last_year", "USC00043182_oct_apr_mm_last_year")]

tab_for_glm$min_fall_flow = tab_for_glm$min_fall_flow/10^6
```



### Predicted and observed $V_{min.~30~days}$ over time

```{r prep_v_min_over_time, echo=FALSE, warning=F}

# A. lm, sep Flows predicted by SWJ snow max + FJ rainfall
pred1 = "SWJ_max_wc_mm"; pred2 = "USC00043182_oct_apr_mm"
tab_for_glm2a = tab_for_glm[!is.na(tab_for_glm$min_fall_flow * 
                                     tab_for_glm[,pred1] * tab_for_glm[,pred2]),]
f2a = paste(c("min_fall_flow ~ ", paste(c(pred1, pred2), collapse = " + ")))
glm_2a = glm(f2a, data = tab_for_glm2a)

# set coef. for AWI calc
if(is.element(el="(Intercept)", set = names(coef(glm_2a))) ){
  intercept = coef(glm_2a)["(Intercept)"]
} else { intercept = 0}

m_SWJ = coef(glm_2a)[pred1]
m_fjppt = coef(glm_2a)[pred2]

dsb_tab$AWI = intercept + 
  dsb_tab$SWJ_max_wc_mm * m_SWJ + 
  dsb_tab$USC00043182_oct_apr_mm * m_fjppt

```

```{r generate_v_min_over_time, echo=FALSE, include=F}
# save as png and include in Rmd
running_fig_num = running_fig_num+1
running_fig_num_txt = str_pad(running_fig_num, width = 2, side = "left", pad="0")
fig_file_name = paste0("f",running_fig_num_txt, ".png")

png(filename = fig_file_name, height = 6.5, width = 7, units = "in", res = img_res)
#make room for 2nd axis
par(mar = c(5,5,3,5), mfrow = c(2,1))
v_min_plots()
dev.off()
```

```{r v_min_over_time, echo=FALSE, fig.cap="\\label{fig:v_min_over_time} Observed and predicted minimum 30-day dry season baseflows both trend downward between the three eras of the period of record (top panel). The predicted-minus-observed difference (residual) over time also reflects this trend, underpredicting minimum flows pre-1977 and overpredicting them post-2000 (middle panel). The predictive model is based on observations from the full record, but three additional models were generated based on only the observations from Eras 1, 2, and 3. Residuals based on Era 1 data are similar to those of the full record; Era 2 residuals tend to overpredict more than the full record; and Era 3 residuals show better performance post-2000 than the full record, but significant underprediction pre-2000." , out.width="100%", warning=F}

knitr::include_graphics(fig_file_name)
```

```{r awi_rmse_calcs, echo = F, include = F, warning = F}
resids = dsb_tab$min_fall_flow/10^6 - dsb_tab$AWI
awi_rmse = sqrt(mean((resids)^2,na.rm=T))
min_fall_flow_mean = mean(dsb_tab$min_fall_flow/10^6, na.rm=T)

```

The $V_{min.~30~days}$ formulation proposed above predicts minimum 30-day dry season baseflows with a model error of 2.3 Mm^3^ (`r  round(2.3*Mm3month_30day_to_cfs,1)` cfs), and a root mean squared error of `r  round(awi_rmse,1)` Mm^3^ (`r  round(awi_rmse*Mm3month_30day_to_cfs,1)` cfs). 

Matching the historical trends of decreasing snowpack, the observed and predicted $V_{min.~30~days}$ values show a downward trend over time (\autoref{fig:v_min_over_time}, top panel). An outlier in the year 1984 reflects extremely high minimum dry season baseflows, relative to the predicted values and the overall distribution. In that year, a relatively high-baseflow season was followed by an early September storm. The model residual (predicted minus observed flow volumes) for this year is also an outlier, indicating that the model has a sufficient sample size to not be overwhelmed by this extreme value produced by an extremely uncommon sequence of events (\autoref{fig:v_min_over_time}, middle panel). 

The predictive $V_{min.~30~days}$ model is based on observations from the full record, but three additional models were generated based on only the observations from each period: Eras 1, 2, and 3, respectively. Residuals based on Era 1 data are similar to those of the full record, with a slight but systematic overprediction in Era 3; Era 2 residuals tend to overpredict in Era 1 more than the full record; and Era 3 residuals offer better performance in Era 3 than the full record, but produce significant systematic underpredictions pre-2000 (\autoref{fig:v_min_over_time}, middle panel).



## Predicted values of $P_{spill}$

### Predictor assessment and prediction formula

The results of the predictor assessment for the $P_{spill}$ prediction formula were similar to those for $V_{min.~30~days}$, in that the two best single predictors were October-April cumulative precipitation and maximum snowpack (\autoref{fig:one_predictor_model_p_spill}, top two panels), with LOOCV model errors of 695 and 496 mm, respectively. (ET_{ref} was once again excluded from consideration based on a short record length.) Again similar to $V_{min.~30~days}$, the best two-predictor model was the combination of the two best single predictors, with an LOOCV error of 461 mm (\autoref{fig:two_predictor_model_p_spill}, upper left panel).

Several combinations of correlated observation categories produced comparable model results, such as spring water levels with maximum snow, maximum snow timing, and cumulative precipitation (\autoref{fig:two_predictor_model_p_spill}, upper right and two middle panels). However, not all combinations of co-correlated data produced reasonable predictors; a model with a linear combination of maximum snowpack timing and March flow volumes performed relatively poorly (LOOCV error of 1,005 mm; \autoref{fig:two_predictor_model_p_spill}, lower right panels).

Based on these results, the model selected as the $P_{spill}$ formulation for a given water year was a linear combination of the same observation records as $V_{min.~30~days}$: snowpack maximum from the SWJ snow station (with data collected by CDEC) and cumulative October-April precipitation from the Fort Jones Ranger Station weather station (station ID USC00043182, with data collected by NOAA).

$$P_{spill,~i} = 123 -0.111 * FJRS_{Oct-Apr,~i} - 0.0274* SWJ_{max,~i}$$

Where:

* $P_{spill,~i}$ is the predicted value of cumulative rainfall at the end of the dry season, starting Sep. 1, on the first day that the Fort Jones gauge records flow greater than or equal to 100 cfs in calendar year $i$ (i.e., at the end of water year $i$) (millimeters)
* $SWJ_{max,~i}$ is the maximum snow water content recorded at the Swampy John snow course (CDEC station ID SWJ or 285) in water year $i$ (millimeters)
* $FJRS_{Oct-Apr,~i}$ is the cumulative precipitation, recorded October-April of water year $i$, measured at the Fort Jones Ranger Station (NOAA station ID USC00043182) (millimeters)

```{r prep_one_predictor_model_p_spill, echo=FALSE, include=F}

pred1s_single = c("SWJ_max_wc_mm", 
                  "USC00043182_oct_apr_mm", 
                  "SWJ_jday_of_max", 
                  "springWL_416295N1228926W001", 
                   "et0_oct_apr", "apr_flow")
lm_results = data.frame(matrix(data = NA, nrow = length(pred1s_single), ncol = 9))
colnames(lm_results)= c("pred", "p_val", 
                        "r_square", "adj_r_square", "f_stat", "AICc",
                        "loocv", "rmse", "n_samp")

titles = c("Snow maximum", "Oct.-Apr. Precip.", 
           "Snow maximum timing", "March-May WLs", 
           "ET Ref.", "March flow vol.")
ylabs = c("SWJ snow max", "FJRS Oct-Apr precip.",
          "SWJ snow max timing", 
          "Mar-May WLs, well 416295N1228926W001",
           "Oct.-Apr. ref. ET (CIMIS stn 225)", "March FJ gauge flow vol.")
```

```{r generate_one_predictor_model_p_spill, echo=FALSE, include=F}

# save as png and include in Rmd
running_fig_num = running_fig_num+1
running_fig_num_txt = str_pad(running_fig_num, width = 2, side = "left", pad="0")
fig_file_name = paste0("f",running_fig_num_txt, ".png")

png(filename = fig_file_name, height = 7.5, width = 7, units = "in", res = img_res)
par(mfrow = c(3,2))
for(i in 1:length(pred1s_single)){
 lm_results[i,] = one_pred_p_spill(pred1 = pred1s_single[i],
                   tab_for_glm_p_spill = dsb_tab, 
                   make_plot = T,
                   return_lm_results = T,
                   yaxis_label = ylabs[i] ,plot_title = titles[i]) 
}
dev.off()
# View(lm_results)

```

```{r one_predictor_model_p_spill, echo=FALSE, fig.cap= "\\label{fig:one_predictor_model_p_spill} Single-predictor models of P spill, the cumulative precipitation after the dry season needed to generate 100 cfs of flow in the Scott River." , out.width="100%", warning=F}
knitr::include_graphics(fig_file_name)

```


```{r pspill_two_pred_data_exp, echo=FALSE, warning=F}

#Reduce columns for the error calc and prediction calc
tab_for_glm_p_spill = dsb_tab[,c("era","era_color_pspill",
                                       "cum_ppt_on_first_day_100cfs",
                                       "SWJ_max_wc_mm",
                                       "USC00043182_oct_apr_mm",
                                       # "aprWL_415635N1228315W001","aprWL_416295N1228926W001",
                                       "springWL_415635N1228315W001",
                                       "springWL_416295N1228926W001",
                                       "SWJ_jday_of_max", "USC00043182_jday_of_median",
                                       "et0_oct_apr", "mar_flow",
                                       "SWJ_max_wc_mm_last_year",
                                       "USC00043182_oct_apr_mm_last_year",
                                       # "aprWL_416295N1228926W001_last_year"
                                       "springWL_416295N1228926W001_last_year")]


# F. Predict precip with 2 predictors


save_2pred_combos_pdf=F
if(save_2pred_combos_pdf == T){
  # Data Exp!
  keep_these_cols_preds = c(#"mar_flow", "apr_flow", 
    "SWJ_max_wc_mm", "SWJ_jday_of_max",
    "USC00043182_oct_apr_mm", "springWL_416295N1228926W001",
    "et0_oct_apr", "mar_flow")
  
  pspill_lm_preds = t(combn(x = keep_these_cols_preds, m = 2))
  lm_results = data.frame(matrix(data = NA, nrow = nrow(pspill_lm_preds), ncol = 11))
  colnames(lm_results)= c("pred1", "pred2", "p_val1", "p_val2",
                          "r_square", "adj_r_square", "f_stat", "AICc",
                          "loocv", "rmse", "n_samp")
  lm_results$pred1=pspill_lm_preds[,1]
  lm_results$pred2=pspill_lm_preds[,2]
  
  pdf("pspill 2 pred models.pdf", height = 11, width = 8.5)
  par(mfrow = c(3,2))
  for(i in 1:nrow(pspill_lm_preds)){
    pred1i = lm_results$pred1[i]; pred2i = lm_results$pred2[i]
    lm_results[i,] = two_pred_p_spill(pred1 = pred1i,
                                      pred2 = pred2i,
                                      yaxis_label = paste(pred1i,"+", pred2i),
                                      tab_for_glm_p_spill = dsb_tab, 
                                      make_plot = T)
  }
  dev.off()
}

```

```{r prep_two_predictor_model_p_spill, echo=FALSE, include=F}

# Set up for plotting and tabulating LM results
pred1s = c("SWJ_max_wc_mm",
           "SWJ_max_wc_mm",
           "USC00043182_oct_apr_mm", 
           "springWL_416295N1228926W001",
           "mar_flow", "et0_oct_apr")

pred2s = c("USC00043182_oct_apr_mm",
           "springWL_416295N1228926W001",
           "springWL_416295N1228926W001",
           "SWJ_jday_of_max",
           "SWJ_jday_of_max", "USC00043182_oct_apr_mm")

lm_results2 = data.frame(matrix(data = NA, nrow = length(pred1s), ncol = 11))
colnames(lm_results2)= c("pred1", "pred2", "p_val1", "p_val2",
                        "r_square", "adj_r_square", "f_stat", "AICc",
                        "loocv", "rmse", "n_samp")

titles = c("Snow and Precip.",
           "Spring WLs and Snow",
           "Spring WLs and Precip.",
           "Snow timing and Mar-May WLs",
           "Snow timing and Mar. flow vol.",
           "Ref. ET and Precip.")
ylabs =  c("snow max and Oct-Apr precip.",
           "Mar-May WLs and snow max",
           "Mar-May WLs and Oct-Apr precip.",
           "snow max timing Mar-May WLs",
           "snow max timing and Mar. flow vol.",
           "Oct-Apr ref. ET and precip.")
```

```{r generate_two_predictor_model_p_spill, echo=FALSE, include=F}

# save as png and include in Rmd
running_fig_num = running_fig_num+1
running_fig_num_txt = str_pad(running_fig_num, width = 2, side = "left", pad="0")
fig_file_name = paste0("f",running_fig_num_txt, ".png")

png(filename = fig_file_name, height = 7.5, width = 7, units = "in", res = img_res)
par(mfrow = c(3,2))
for(i in 1:length(pred1s)){
  lm_results2[i,] = two_pred_p_spill(pred1 = pred1s[i], 
                                  pred2 = pred2s[i],
                                  tab_for_glm_p_spill = dsb_tab, 
                                  make_plot = T,
                                  return_lm_results = T, 
                                  plot_title = titles[i], yaxis_label =ylabs[i]) 

}
dev.off()
# View(lm_results2)

```

```{r two_predictor_model_p_spill, echo=FALSE, fig.cap= "\\label{fig:two_predictor_model_p_spill} Two-predictor models of P spill, the cumulative precipitation after the dry season needed to generate 100 cfs of flow in the Scott River." , out.width="100%", warning=F}
knitr::include_graphics(fig_file_name)
```


<!-- ### Predicted and observed $P_{spill}$ over time -->
### Predicted and observed $P_{spill}$ over time

```{r pspill_rmse_calcs, echo = F, include = F, warning = F}

# Predict P_spill

pred1 = "USC00043182_oct_apr_mm"; pred2 = "SWJ_max_wc_mm"
tab_for_glm1h = dsb_tab[!is.na(dsb_tab$cum_ppt_on_first_day_100cfs * 
                                     dsb_tab[,pred1] *dsb_tab[,pred2]) ,]
f1h = paste("cum_ppt_on_first_day_100cfs ~ ", pred1,"+",pred2)

glm_1h = lm(f1h, data = tab_for_glm1h)
# lm_1h = lm(f1h, data = tab_for_glm1h)
# summary(lm_1h) # get R square

# set coef. for P_spill calc
if(is.element(el="(Intercept)", set = names(coef(glm_1h))) ){
  intercept = coef(glm_1h)["(Intercept)"]
} else { intercept = 0}

dsb_tab$p_spill_pred = predict.glm(object = glm_1h, newdata=dsb_tab)


# m_SWJ_pspill = coef(glm_1h)[pred1]
# 
# dsb_tab$p_spill_pred = intercept + 
#   dsb_tab[,pred1] *  m_SWJ_pspill #+ 
  # dsb_tab$USC00043182_oct_apr_mm * m_fjppt

# Calculate numbers for discussion
resids = dsb_tab$p_spill_pred - dsb_tab$cum_ppt_on_first_day_100cfs
pspill_rmse = sqrt(mean((resids)^2,na.rm=T))
p_spill_mean = mean(dsb_tab$cum_ppt_on_first_day_100cfs, na.rm=T)

```




The $P_{spill}$ estimate formulation proposed above predicts $P_{spill}$ values with a model LOOCV error of 461 mm (`r  round(461*mm_to_in,1)` inches), and a root mean squared error of `r  round(pspill_rmse,1)` mm (`r  round(pspill_rmse*mm_to_in,1)` inches). 

Matching the historical trends of decreasing snowpack, the observed and predicted $P_{spill}$ values show an increasing trend over time (\autoref{fig:pspill_pred_over_time}, top panel). A high outlier in calendar year 1994 (in early water year 1995) was caused by a dry water year 1994 followed by a series of small storms in November and December, none of which produced 100 cfs of flow, followed by a much larger storm on January 8th-9th of 1995 in which the river flow jumped to 600 and then 7,500 cfs in two days.

The predictive $P_{spill}$ model is based on observations from the full record, but three additional models were generated based on only the observations from each period: Eras 1, 2, and 3, respectively. Residuals based on Era 1 tend to underpredict Eras 2 and 3 more than the full-record model; Era 2 residuals tend to overpredict in Eras 1 and 3 more than the full record; and Era 3 residuals have a slightly higher tendency to underpredict than the full record, but overall are fairly similar to the full-record residuals (\autoref{fig:v_min_over_time}, lower panel).

```{r generate_pspill_pred_over_time, include=F}

# plot(dsb_tab$year, dsb_tab$cum_ppt_on_first_day_100cfs, pch = 19, type = "o")
# points(dsb_tab$year, dsb_tab$p_spill_pred, pch = 18, col ="red", type = "o")

# save as png and include in Rmd
running_fig_num = running_fig_num+1
running_fig_num_txt = str_pad(running_fig_num, width = 2, side = "left", pad="0")
fig_file_name = paste0("f",running_fig_num_txt, ".png")

png(filename = fig_file_name, height = 6.5, width = 7, units = "in", res = img_res)
#make room for 2nd axis
par(mar = c(5,5,3,5), mfrow = c(2,1))
p_spill_plots(tab_for_glm = tab_for_glm1h)
dev.off()


#make room for 2nd axis
# par(mar = c(5,5,3,5), mfrow = c(3,1))
# v_min_plots()
# 
```

```{r pspill_pred_over_time, echo=FALSE, fig.cap="\\label{fig:pspill_pred_over_time} Observed and predicted values of P spill (top panel) indicate a worse model fit for the P spill prediction than for minimum 30-day dry season baseflows (Figure 9). Serious overprediction in Era 1 is followed by more mixed over- and under-prediction in Eras 2 and 3 (bottom panel). The overall P spill model is based on observations from the full record, but three additional models were generated based on only the observations from Eras 1, 2, and 3. Residuals based on Era 1 data are generally lower than those from Eras 2 or 3 or from the full record." , out.width="100%", warning=F}
knitr::include_graphics(fig_file_name)
```



## Comparison with California DWR Water Year Type (WYT) category


```{r wyt_data_processing, echo = F, include = F, warning = F}
# Predict P_spill
# dsb_tab$p_spill_pred = predict.glm(object = glm_1h, newdata=dsb_tab)

wyt = read.csv(file.path(local_data_dir,"DWR_SGMA_WYT_ScottR.csv"))

wyt_cat = data.frame(descrip = c("Critical","Dry","Below Normal", "Above Normal", "Wet"),
                     descrip_abbrev = c("Crit.", "Dry", "BN", "AN", "Wet"),
                     color = c("firebrick","orangered","goldenrod","green3","dodgerblue"),
                     plot_val=1:5)
# wyt$plot_val = wyt_cat$value[match(wyt$WYT, wyt_cat$descrip)]
wyt = merge(wyt, wyt_cat, by.x="WYT", by.y="descrip")
wyt=wyt[order(wyt$WY),]

dsb_tab$dwr_wyt = wyt$WYT[match(dsb_tab$year, wyt$WY)]
dsb_tab$dwr_wyt = factor(dsb_tab$dwr_wyt, levels = wyt_cat$descrip)
dsb_tab$dwr_wyt_lag1 = NA
dsb_tab$dwr_wyt_lag1[1:(nrow(dsb_tab)-1)] = dsb_tab$dwr_wyt[2:nrow(dsb_tab)]

dsb_tab$dwr_wyt_col = wyt_cat$color[match(dsb_tab$dwr_wyt, wyt_cat$descrip)]
dsb_tab$dwr_wyt_lag1_col = wyt_cat$color[match(dsb_tab$dwr_wyt_lag1, wyt_cat$descrip)]
```  



```{r generate_resp_vars_wyt, echo=FALSE, include=F}

# save as png and include in Rmd
running_fig_num = running_fig_num+1
running_fig_num_txt = str_pad(running_fig_num, width = 2, side = "left", pad="0")
fig_file_name = paste0("f",running_fig_num_txt, ".png")


png(filename = fig_file_name, height = 7, width = 7, units = "in", res = img_res)

par(mfrow = c(3,1), mar = c(3, 4, 2, 2))

plot(y = dsb_tab$min_fall_flow / 10^6, x = dsb_tab$dwr_wyt,
     pch = 19, col = wyt_cat$color ,#col = dsb_tab$dwr_wyt_col, 
     main = "DWR Water Year Type category and minimum dry season baseflows", 
     ylab = "V min (Mm3 / 30 days)", xlab = "")
grid()
plot(y = dsb_tab$cum_ppt_on_first_day_100cfs, x = dsb_tab$dwr_wyt,
     pch = 19, col = wyt_cat$color ,#col = dsb_tab$dwr_wyt_col, 
     main = "DWR Water Year Type category and P Spill (in following water year)", 
     ylab = "P spill (mm)", xlab = "")
grid()

dwr_wyt_fig()

dev.off()


```

```{r resp_vars_wyt, echo=FALSE, fig.cap="\\label{fig:resp_vars_wyt} DWR Water Year Type indices over time and compared to the two metrics of hydrologic conditions developed in this study: minimum 30-day dry season baseflow volume (V min) and the amount of precipitation necessary to produce 100 cfs flow in the Scott River (P spill)." , out.width = "100%", warning=F}
knitr::include_graphics(fig_file_name)
```

The DWR water year type categories map fairly well onto the two proposed hydrologic indices $V_{min.~30~days}$ and $P_{spill}$ (\autoref{fig:resp_vars_wyt}, upper two panels), which is to be expected, as both DWR WYT and the two proposed indices are based in part on cumulative precipitation data. However, there is less of an ability to identify a long-term trend in the DWR WYT index time series than in the time series of observed or predicted $V_{min.~30~days}$ or $P_{spill}$ values. Likely causes include the information lost when binning water years into five categories, and the 30-year ranking window that would prevent a direct comparison of post-2000 WYTs with pre-1950s WYTs (\autoref{fig:resp_vars_wyt}, lower panel).

# Discussion

## Scott River watershed behavior

The degree to which these forward-looking seasonal predictions are accurate depends on fundamental hydrologic relationships between climate inputs and flow outputs, with some complications introduced by water evaporating or transpiring through native or cultivated vegetation. The condition of a "full" watershed can be operationally defined as a highly responsive to new precipitation. The condition is transient, and proximity to a full condition relies on the balance of slow draining and rapid filling flowrates in any given rainy season. However, in this Mediterranean climate, the general shape of the relationship between cumulative precipitation-runoff behavior is preserved in dry and wet water years (\autoref{fig:time_v_fall_rains_v_flow_fig}, panel B).

Although a $Q_{spill}$  of `r Q_spill` cfs was identified by visual inspection of aggregate fall hydrograph behavior (\autoref{fig:time_v_fall_rains_v_flow_fig}), it also matches information from local stakeholders. Many tributary streams on the valley floor run dry during the summer and fall, and some tributary streams respond more quickly to fall precipitation than others. Generally, the timing of all tributaries reaching flowing status corresponds with the Fort Jones gauge reaching 100 cfs [@Sommarstrom2020].

Simulated estimates of stream-aquifer exchange corroborates these precipitation-flow relationships. Dry season baseflow ($V_{min.~30~days}$) and the onset of wet season flow (framed in terms of $P_{spill}$) are both influenced by net groundwater discharge from the aquifer. One interpretation of the high frequency of near-0 net monthly stream-aquifer flux values (\autoref{fig:flow_to_aq_and_stream}) is that the high degree of connectivity between the streams and the aquifer in the Scott River system produces balancing counter-forces in response to hydrologic stresses on the system, such as large recharge events. This balancing tendency can be temporarily overwhelmed by large precipitation pulses, but high-flow conditions quickly reduce the volume of water in the surface water system, returning the Scott River to a baseline of nearly-balanced stream-to-aquifer and aquifer-to-stream fluxes. This dynamic also reflects the small size of the available aquifer storage, relative to the amount of precipitation received by the watershed in a given water year [@DWR2004].

The resulting water storage limitations mean that multi-year planning, such as the long-term GSP projects, may be impossible in the Scott River watershed without making assumptions about how much it will rain [i.e., the future climate predictions in Siskiyou County -@SiskiyouCounty2021]. If those assumptions are not fulfilled by future climate, year-by-year adaptive management may be necessary to achieve management outcomes. 

## $V_{min.~30~days}$ and $P_{spill}$ prediction utility

Though various methods exist to qualitatively predict, in the spring, the severity of the coming low-flow season in the Scott River watershed, a quantitative short-term forecasting index could support more rigorous thresholds for adaptive management. To this end we developed two linear equations for predicting minimum dry season baseflows about five months in advance, effectively taking an inventory in each April of relevant hydrologic inputs. It could be used to support decisions made in the late spring timeframe regarding the growing season, such as potential regulatory actions and some farmer cropping decisions. 

There are several methods in current use. Observations at existing monitoring locations, such as weather stations and long-term snow course records, have been used as ad-hoc hydrologic indices. Historical adaptive management decisions in the Scott River watershed, such as planning to purchase surface water rights leases, have relied on individual monitoring observations, such as percent of snowpack relative to average conditions, or the Fort Jones flow in the spring [e.g., @SRWT2018]. <!-- *[cite for adaptive mgmt decision by farmer - comment Tom Menne made in a stakeholder meeting about planting more grain in 2021]?* --> Additionally, DWR has effectively extended the methodology of the SVI and SJI metrics to all of California by publishing a categorical water year type (WYT) index for all its major watersheds [to the HUC8 level; @DWR2021a]. This metric quantifies meteoric drought and relies only on precipitation data, so as to be comparable across the state. Matching SVI and SJI methodology, it can be calculated at multiple points in each spring, with a final determination in May, but in the case of Scott Valley it has been used to classify WYTs only retroactively through 2018. As previously mentioned it is a relatively complex metric with provisions including a partial one-year holdover (i.e., dry conditions in the previous year will make a dry-type categorization more likely the following year), and non-stationary index thresholds, with a 30-year ranking window. 

The proposed quantitative prediction methods map well onto the existing DWR WYT index, but preserve more detailed information. The primary advantages of the proposed method over these and other previous methods of gauging near-term hydrologic conditions is that it is tailored to local hydroclimate data and is interpretable as a numeric prediction of fall conditions. This could be used to inform regulatory actions in an attempt to increase fall environmental flows, or for surface water diverters to plan for low-flow conditions.

Though it also serves as an indication of the severity of a water year, the additional specific utility of the second predicted metric, $P_{spill}$, may be less than for that of minimum dry season baseflows. Management decisions such as the last possible date to keep a temporary stream gauge installed in a river, without risk of it being washed out, could be informed by a $P_{spill}$ prediction when combined with weather forecasts in the fall. 

## Management implications of best-performing predictors

As described in Results, the linear models that best predicted observed values of $V_{min.~30~days}$ and $P_{spill}$ were both based on the same two observation locations (the SWJ snow course and the FJRS weather station; \autoref{fig:watershed_fig_ch3}), both with lengthy observation records. One interpretation of these results is that the climate inputs produce a predictable fall watershed response, and that human management decisions have a negligible influence on fall river flow. However, model simulations suggest that the timing and magnitude of fall flow increases can be influenced by human water use [e.g., scenarios in Siskiyou County -@SiskiyouCounty2021]. 

Multiple possible explanations could reconcile these two pieces of seemingly contradictory evidence. First, random variability in human water use could be a contributing factor to the error of the predictive models of fall-season hydrologic behavior. Alternatively, human water uses could be so consistent in response to wet or dry season conditions that these water uses could be implicitly incorporated into the predictive models. If adaptive management actions (potentially including events as diverse as regulatory curtailments or individual cropping choices) are carefully recorded in the future, they could be compared to residuals of the climate-based predictive models to evaluate whether any signal of a response to human interventions can be observed.


## Influences of climate change on predictive indices

Both predictions (using the full record of hydrologic data) assume some degree of hydroclimate stationarity, in that it uses historical snowpack- and precipitation-runoff relationships to predict modern runoff. In one sense, a longer-term record can be an asset, in that it provides context for the severity of the dry periods of the past two decades. In another sense it is a liability for prediction accuracy: for example, the predicted $V_{min.~30~days}$ values based on the full record appear to systematically overpredict $V_{min.~30~days}$ in the most recent era (2001-2021; \autoref{fig:two_predictor_model}, top left panel, and \autoref{fig:v_min_over_time}, middle panel). This suggests that factors not captured in these climate data, such as warmer air temperatures, changing upland vegetation and evapotranspiration dynamics, and possibly unknown changes in water use, may be altering the relationship between the spring water supply and dry season baseflow rates.


# Conclusions

This study proposed two locally-tailored hydrologic decision-support metrics for the Scott River watershed in northern California. Both use snowpack and cumulative precipitation data from October-April to predict the quantity of interest: the first is the minimum 30-day flow volume in a given water year, referred to as $V_{min}$, which typically occurs in September or October. The second index is the cumulative rainfall needed to "fill" the watershed after the end of the dry season to a "spilling" condition that responds quickly to precipitation events, referred to as $P_{spill}$. Both indices can be calculated at the end of April to support near-term (seasonal) adaptive management regarding the growing season or the fall, similar to the SVI and SJI in California's Central Valley. However, climate change may reduce the predictive accuracy of indices based on long-term data records, and updates based on smaller numbers of more recent water years should be considered periodically.

The management choices facing local managers in this basin are difficult to quantify and summarize, as is the case in basins throughout California and arid regions globally. Locally-derived summary metrics, tailored to regional hydrologic dynamics, have provided and will continue to provide tools for supporting those choices and communicating them to diverse stakeholders and the general public.


```{r scratch_work}
# From the perspective of river flow, the "dry season" and "wet season" can be defined using this spill threshold - the flow rate at which the watershed functionally "spilling", after which point additional rainfall causes a surge in flow. Because a watershed is structurally more complex than a bucket, this threshold is approximate. 

# To determine the approximate numerical value of the spill threshold, we identified the flow value that, when used to divide the dry and wet seasons,   the difference between the rainfall-runoff responses in the dry and wet seasons. evaluated the difference between the dry and wet season rainfall-runoff responses keeps growing until it first levels off at a spill threshold of approximately 120 cfs. At higher values (i.e., defining the start of the wet season as a larger storm event), the average wet season rainfall-runoff response continues to grow, 

# If the threshold is 20 cfs, many water years 
# Using a threshold of Dry season rainfall-runoff response falls with spill thresholds ranging from 10 to 80 cfs and is relatively stable, at . Beyond 80 cfs the dry season runoff increase relative to added precip 

# Between approximately 100 and 140 cfs there is a plateau: t
# 
# 
# calc_dQdP = function(P, Q, dates, lag_days = 1, 
#                      dry_season_day1 = yday(as.Date("2001-09-01")),
#                      result="dQdP"){
#   P_lagged_forward = c(rep(NA, lag_days), P[1:(length(P)-lag_days)])
#   Q_lagged_forward = c(rep(NA, lag_days), Q[1:(length(Q)-lag_days)])
#   
#     # take out annual fenceposts - first x days of each year's dry season (which in this tabular arrangement have lagged values from the preceding year)
#   dates_julian = yday(dates)
#   Q[dates_julian < (lag_days+dry_season_day1) & dates_julian >= dry_season_day1] = NA 
#   P[dates_julian < (lag_days+dry_season_day1) & dates_julian >= dry_season_day1] = NA 
# 
#   dP = P - P_lagged_forward # real time cum. precip. record minus cum. ppt from x days ago
#   dQ = Q - Q_lagged_forward # real time flow record minus flow from x days ago
#   dQdP = dQ/dP
#   if(result=="dQdP"){return(dQdP)}
#   if(result=="dQ"){return(dQ)}
# }
# 
# 
# # calc_dQdPs_multiple_lags = function(fj3d, max_lag_days=6){
# #   starting_ncol = ncol(fj3d)
# #   fj3d[,(starting_ncol+1):(starting_ncol+max_lag_days)] = NA
# #   colnames(fj3d)[(starting_ncol+1):(starting_ncol+max_lag_days)] = paste0("dQdP_lag",1:max_lag_days)
# #   for(lag_days in 1:max_lag_days){
# #     result_colname = paste0("dQdP_lag",lag_days)
# #     fj3d[,starting_ncol+lag_days] = calc_dQdP(P = fj3d$cum_ppt, 
# #                                               Q = fj3d$Flow, 
# #                                               dates = fj3d$Date, 
# #                                               lag_days = lag_days)
# #   }
# #   return(fj3d)
# # }
# 
# 
# calc_cum_dQdPs_multiple_lags = function(fj3d, max_lag_days=6){
#   starting_ncol = ncol(fj3d)
#   fj3d[,(starting_ncol+1):(starting_ncol+max_lag_days)] = NA
#   colnames(fj3d)[(starting_ncol+1):(starting_ncol+max_lag_days)] = paste0("dQdP_lag",1:max_lag_days)
#   for(lag_days in 1:max_lag_days){
#     result_colname = paste0("dQdP_lag",lag_days)
#     fj3d[,starting_ncol+lag_days] = calc_dQdP(P = fj3d$cum_ppt, 
#                                               Q = fj3d$cum_flow_m3, 
#                                               dates = fj3d$Date, 
#                                               lag_days = lag_days)
#   }
#   return(fj3d)
# }
# 
# 
# dQdP_vs_flow = function(lag_days = 1, 
#                         storm_cutoff = 0.5*25.4){ # half inch to mm
# 
#   # Change in flow in X days
#   # q1 = c(fj3d$Flow[1:(nrow(fj3d)-lag_days)], rep(NA, lag_days))
#   q1 = fj3d$cum_flow_m3 # $Flow
#   q2 = c(rep(NA, lag_days), fj3d$cum_flow_m3[1:(nrow(fj3d)-lag_days)])
#   # Change in cumulative precip in X days
#   # p1 = c(fj3d$cum_ppt[1:(nrow(fj3d)-lag_days)], rep(NA, lag_days))
#   p1 = fj3d$cum_ppt
#   # p2 the cumulative precip vector adjusted forward by x days
#   p2 = c(rep(NA, lag_days), fj3d$cum_ppt[1:(nrow(fj3d)-lag_days)])
# 
#   # take out annual fenceposts - first x days of each year (which are just values from the preceding year)
#   fj3d$julian = yday(fj3d$Date)
#   adj_wy_day1 = yday(as.Date("2001-09-01"))
#   q1[fj3d$julian < (lag_days+adj_wy_day1) & fj3d$julian >= adj_wy_day1] = NA 
#   p1[fj3d$julian < (lag_days+adj_wy_day1) & fj3d$julian >= adj_wy_day1] = NA 
#   
#   #calculate dQ (the change in flow in x days) and dP (the change in cum. precip. in x days)
#   fj3d$q1=q1; fj3d$q2=q2; fj3d$p1=p1; fj3d$p2 = p2
#   fj3d$dQ = q1-q2 # time-true record minus the record from x days ago
#   fj3d$dP = p1-p2
#   # Calculate dQdP
#   fj3d$dQdP = fj3d$dQ/fj3d$dP
#   
#   # hist(fj3d$dQdP,xlim = c(-1000,1000), breaks = 300)
#   
#   storm_index = fj3d$ppt >= storm_cutoff
#   # adjust for smoothing days
#   # storm_index_delayed = c(rep(NA,lag_days),
#   #                         storm_index[1:(length(storm_index)-lag_days)])
#   fj3d_storm = fj3d[storm_index,]
#   
#   # summary(fj3d_storm$dQdP,na.rm=T)
#   plot(fj3d_storm$dQdP, fj3d_storm$cum_flow_m3, xlim = c(-1*10^3, 10^3), 
#        pch = 19, col = rgb(0,0,0,.05), log = "y",
#        main = paste("d_Flow d_Precip, \n smoothing", lag_days, "day(s), storm cutoff",storm_cutoff, "mm, storms only"))
#   grid()
#   abline(h=100, col = "brown", lwd=2)
#   
#     plot(fj3d_storm$dP, fj3d_storm$dQ, #xlim = c(-1, 10^2), 
#        pch = 19, col = rgb(0,0,0,.1), log = "y",
#        main = paste("d_Precip vs d_Flow, \n smoothing", lag_days, "day(s), storm cutoff",storm_cutoff, "mm, storms only"))
#   grid()
#   abline(h=100, col = "brown", lwd=2)
# 
#   # plot(fj3d$dQdP, fj3d$Flow, xlim = c(-1*10^3, 10^3), 
#   #      pch = 19, col = rgb(0,0,0,.05), log = "y",
#   #      main = paste("d_Flow d_Precip, \n smoothing", lag_days, "day(s), storm cutoff",storm_cutoff, "mm, all days"))
#   # grid()
#   # abline(h=100, col = "brown", lwd=2)
#   
#   
# }
# 



# computation steps: 
# calculate dQ and dP (Q_i - Q_i-1), and dQ/dP
# don't need days for which dQ is negative. Flow can be falling even on days with some rainfall if it's coming down from a higher peak
# try to skew for early in the wet season so we avoid snowmelt influence
# filter for days that got more than 1/10th inch. Because small dPs can produce high dQ dP values that are not meaningful. 
### why 1/10th inch? make up some bullshit justification about refET in the winter?


# 653 sq miles drainage area for Ft Jones gauge (per USGS https://waterdata.usgs.gov/monitoring-location/11519500/#parameterCode=00060&period=P7D)
# 1 ft3/sec * 1m3/35 ft3 * 86400 sec/day / 1.7m sq meters * 1000mm/m = mm/day



# 
#   #summarize for each threshold
# delta_dqdp_mean = aggregate(x = results$delta_dQdP,
#                             by = list(results$Q_threshold_m3day), FUN = mean,
#                             na.rm=T,finite=T)$x
# delta_dqdp_med = aggregate(x = results$delta_dQdP,
#                             by = list(results$Q_threshold_m3day), FUN = median, na.rm=T)$x
#   #   mean(results_for_wys$delta_dqdp, na.rm=T)
#   # results_for_thresholds$delta_dqdp_med[threshold_picker] = median(results_for_wys$delta_dqdp, na.rm=T)
#   # results_for_thresholds$delta_dqdp_std[threshold_picker] = sd(results_for_wys$delta_dqdp, na.rm=T)
# 
# plot(q_thresh/cfs_to_m3day, delta_dqdp_mean / cfs_to_m3day)
# grid()
# 
# plot(q_thresh/cfs_to_m3day,delta_dqdp_med / cfs_to_m3day)
# grid()

# for(yr in EoDS_years){
#   yr_picker = results$year==yr
#   thresholds = results$Q_threshold_m3day[yr_picker]
#   delta_dqdp = results$delta_dQdP[yr_picker]
# 
#   if(yr==EoDS_years[1]){
#     plot(thresholds/cfs_to_m3day, delta_dqdp/cfs_to_m3day, main = "Effect of dQ threshold value on runoff-rainfall \n responses in end of dry and beginning of wet season",
#          xlab = "dQ end-of-dry-season threshold (m3day)",
#          ylab = "change in dQ/dP (wet season minus dry season)",
#          ylim = range(results$delta_dQdP,na.rm=T, finite=T)/cfs_to_m3day,
#          type = "o", col = rgb(.2,.2,.2,.2))
#   } else {
#     lines(thresholds/cfs_to_m3day, delta_dqdp/cfs_to_m3day, col = rgb(.2,.2,.2,.2), type = "o")
#   }
# }


# thresh_colors = sequential_hcl(n=length(q_thresh), palette = "Hawaii")
# 
# for(i in 1:length(q_thresh)){
#   thresh=q_thresh[i]
#   thresh_picker = results$Q_threshold_m3day==thresh
#   years = results$year[thresh_picker]
#   delta_dqdp = results$delta_dQdP[thresh_picker]
#   thresh_col = thresh_colors[i]
#   
#   if(thresh==q_thresh[1]){
#     plot(years, delta_dqdp/cfs_to_m3day, log="y",
#          main = "Yearly pattern, by threshold, of runoff-rainfall \n responses in end of dry and beginning of wet season",
#          xlab = "Year",
#          ylab = "change in dQ/dP (wet season minus dry season)",
#          # ylim = range(results$delta_dQdP,na.rm=T, finite=T)[2]/cfs_to_m3day,
#          col=thresh_col,# col = rgb(.2,.2,.2,.2),
#          type = "o")
#   } else {
#     lines(years, delta_dqdp/cfs_to_m3day, #col = rgb(.2,.2,.2,.2), 
#           type = "o", col = thresh_col, pch=3)
#   }
# }

# if(write_q_thresh_pdf){
#   pdf(file = "First spill day viewer, all WYs_120cfs.pdf", width = 8.5, height = 11)
#   par(mfrow = c(2,1), mar = c(5,4,4,4)*1.1)
#   for(yr in EoDS_years){
#     dQdP_vs_hydrograph(fj3d = fj3d, 
#                        storm_cutoff = 6.35,
#                        date_1 = as.Date(paste0(yr,"-09-01")), 
#                        date_2 = as.Date(paste0(yr+1,"-02-01")),
#                        as_png = F, 
#                        max_lag_days = 1,
#                        Q_spill_threshold = 120) #threshold in cfs
#   }
#   
#   dev.off()
# }


```